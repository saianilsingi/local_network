<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìù Text & üì∑ Image Saver</title>
<style>
  body { font-family: "Segoe UI", Tahoma, sans-serif; margin:0; background:#f4f6f9; color:#222; }
  header { background:linear-gradient(135deg,#4a90e2,#007aff); color:white; padding:16px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
  main{max-width:1000px;margin:20px auto;padding:16px;display:flex;gap:20px;flex-wrap:wrap;}
  section{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.08);flex:1 1 420px;transition:transform 0.2s;}
  section:hover{transform:translateY(-3px);}
  h2{margin-top:0;font-size:20px;border-bottom:2px solid #f0f0f0;padding-bottom:8px;}
  textarea{width:100%;height:180px;padding:10px;border:1px solid #ccc;border-radius:8px;resize:vertical;font-size:16px;outline:none;transition:border 0.2s;}
  textarea:focus{border-color:#4a90e2;}
  .upload-label{display:inline-block;background:#007aff;color:#fff;padding:10px 15px;border-radius:6px;cursor:pointer;transition:background 0.2s;}
  .upload-label:hover{background:#005bb5;}
  input[type="file"]{display:none;}
  .action-btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;transition:background 0.2s;}
  .remove-btn{background:#e74c3c;color:#fff;}
  .remove-btn:hover{background:#c0392b;}
  .meta{font-size:12px;color:#666;margin-top:8px;}
  #status{position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:8px 12px;border-radius:999px;font-size:13px;opacity:0.9;}
  img.preview{max-width:100%;max-height:360px;border-radius:8px;margin-top:12px;cursor:pointer;transition:transform 0.3s;}
  img.preview:hover{transform:scale(1.03);}
  @media(max-width:768px){main{flex-direction:column;}}
</style>
</head>
<body>
<header><h1>üìù Text & üì∑ Image Saver</h1></header>
<main>
  <section>
    <h2>Shared Text</h2>
    <textarea id="sharedBox" placeholder="Start typing..."></textarea>
    <div class="meta" id="textMeta"></div>
  </section>

  <section>
    <h2>Image</h2>
    <label class="upload-label" for="fileInput">Upload Image</label>
    <input type="file" id="fileInput" accept="image/*" />
    <div id="imageContainer"></div>
    <div class="meta" id="imageMeta"></div>
  </section>
</main>

<div id="status">Initializing...</div>

<script>
/* ---------- device id ---------- */
function getDeviceId(){
  let id = localStorage.getItem("device_id_v1");
  if(!id){ id = crypto.randomUUID(); localStorage.setItem("device_id_v1", id); }
  return id;
}
const DEVICE_ID = getDeviceId();

/* ---------- detect local subnet (WebRTC) ---------- */
async function getLocalSubnet(){
  return new Promise(resolve=>{
    const pc = new RTCPeerConnection({iceServers:[]});
    pc.createDataChannel("");
    pc.createOffer().then(offer=>pc.setLocalDescription(offer)).catch(()=>{});
    pc.onicecandidate = ev => {
      if(ev?.candidate?.candidate){
        const parts = ev.candidate.candidate.split(" ");
        const addr = parts[4];
        if(/^(192\.|10\.|172\.)/.test(addr)){
          resolve(addr.split(".").slice(0,3).join("."));
          try{ pc.close(); }catch(e){}
        }
      }
    };
    setTimeout(()=>{ try{pc.close()}catch{}; resolve(null); },1000);
  });
}

/* ---------- UI wiring ---------- */
const sharedBox = document.getElementById("sharedBox");
const fileInput = document.getElementById("fileInput");
const imageContainer = document.getElementById("imageContainer");
const textMeta = document.getElementById("textMeta");
const imageMeta = document.getElementById("imageMeta");
const status = document.getElementById("status");

let localSubnet = null;
let typingTimer = null;
let isTyping = false;

function buildHeaders(){
  const h = { "X-Device-ID": DEVICE_ID };
  if(localSubnet) h["X-Local-Subnet"] = localSubnet;
  return h;
}

async function fetchLatest(){
  try{
    const res = await fetch("/get", { headers: buildHeaders() });
    if(!res.ok){
      const err = await res.json().catch(()=>({error:'unknown'}));
      status.textContent = `Sync error: ${err.error || res.status}`;
      return null;
    }
    const data = await res.json();
    if(!data.success){ status.textContent = "No data"; return null; }
    status.textContent = "Synced";
    return data;
  }catch(e){ console.error(e); status.textContent = "Offline"; return null; }
}

function formatTS(ts){ return ts ? new Date(ts).toLocaleString() : ""; }

async function refreshUI(){
  const data = await fetchLatest();
  if(!data) return;

  if(!isTyping && (data.text||"") !== sharedBox.value){
    sharedBox.value = data.text || "";
  }
  textMeta.textContent = data.updated_at ? `Updated: ${formatTS(data.updated_at)}` : "";

  // image area
  imageContainer.innerHTML = "";
  if(data.image_url){
    const img = document.createElement("img");
    img.src = data.image_url; img.className="preview"; img.onclick = ()=>window.open(data.image_url, "_blank");
    imageContainer.appendChild(img);

    // Delete allowed only if owner_device_id matches (or if null)
    const owner = data.owner_device_id;
    const canDelete = !owner || owner === DEVICE_ID;
    if(canDelete){
      const btn = document.createElement("button");
      btn.textContent = "‚ùå Remove Image";
      btn.className = "action-btn remove-btn";
      btn.onclick = async ()=>{
        await deleteImage();
        await refreshUI();
      };
      imageContainer.appendChild(btn);
    }
    imageMeta.textContent = data.updated_at ? `Updated: ${formatTS(data.updated_at)}` : "";
  } else {
    imageMeta.textContent = "";
  }
}

async function sendText(text){
  try{
    const res = await fetch("/set", {
      method: "POST",
      headers: Object.assign({"Content-Type": "application/json"}, buildHeaders()),
      body: JSON.stringify({ text })
    });
    if(!res.ok){ const err = await res.json().catch(()=>({error:'unknown'})); console.error("Save failed", err); return; }
    const data = await res.json();
    if(!data.success) console.error("Save failed", data.error);
  }catch(e){ console.error("sendText error", e); }
}

async function uploadImageFile(file){
  try{
    const fd = new FormData();
    fd.append("image", file);
    const res = await fetch("/upload_image", { method: "POST", headers: buildHeaders(), body: fd });
    if(!res.ok){ const err = await res.json().catch(()=>({error:'unknown'})); alert("Upload failed: "+(err.error||res.status)); return; }
    const data = await res.json();
    if(!data.success) alert("Upload failed: "+(data.error||"unknown"));
    return data;
  }catch(e){ console.error("uploadImageFile", e); alert("Upload error"); }
}

async function deleteImage(){
  try{
    const res = await fetch("/delete_image", { method: "POST", headers: buildHeaders() });
    if(!res.ok){ const err = await res.json().catch(()=>({error:'unknown'})); alert("Delete failed: "+(err.error||res.status)); return; }
    const data = await res.json();
    if(!data.success) alert("Delete failed: "+(data.error||"unknown"));
  }catch(e){ console.error("deleteImage", e); alert("Delete error"); }
}

/* ---- events ---- */
sharedBox.addEventListener("input", ()=>{
  isTyping = true;
  clearTimeout(typingTimer);
  typingTimer = setTimeout(async ()=>{
    isTyping = false;
    await sendText(sharedBox.value);
  }, 600);
});

fileInput.addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  if(f.size > (5 * 1024 * 1024)){ alert("Image too large (max 5 MB)"); return; }
  if(!/^image\//.test(f.type)){ alert("Please upload an image file"); return; }
  await uploadImageFile(f);
  fileInput.value = "";
  await refreshUI();
});

/* ---------- init ---------- */
(async function init(){
  status.textContent = "Detecting subnet...";
  localSubnet = await getLocalSubnet();
  status.textContent = "Ready";
  await refreshUI();
  setInterval(refreshUI, 3000);
})();
</script>
</body>
</html>
