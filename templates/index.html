<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìù Text & üì∑ Image Saver</title>
<style>
  body { font-family: "Segoe UI", Tahoma, sans-serif; margin:0; background:#f4f6f9; color:#222; }
  header { background:linear-gradient(135deg,#4a90e2,#007aff); color:white; padding:16px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
  main{max-width:1000px;margin:20px auto;padding:16px;display:flex;gap:20px;flex-wrap:wrap;}
  section{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.08);flex:1 1 420px;transition:transform 0.2s;}
  section:hover{transform:translateY(-3px);}
  h2{margin-top:0;font-size:20px;border-bottom:2px solid #f0f0f0;padding-bottom:8px;}
  textarea{width:100%;height:180px;padding:10px;border:1px solid #ccc;border-radius:8px;resize:vertical;font-size:16px;outline:none;transition:border 0.2s;}
  textarea:focus{border-color:#4a90e2;}
  .upload-label{display:inline-block;background:#007aff;color:#fff;padding:10px 15px;border-radius:6px;cursor:pointer;transition:background 0.2s;}
  .upload-label:hover{background:#005bb5;}
  input[type="file"]{display:none;}
  .action-btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;transition:background 0.2s;}
  .remove-btn{background:#e74c3c;color:#fff;}
  .remove-btn:hover{background:#c0392b;}
  .meta{font-size:12px;color:#666;margin-top:8px;}
  #status{position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:8px 12px;border-radius:999px;font-size:13px;opacity:0.9;}
  img.preview{max-width:100%;max-height:360px;border-radius:8px;margin-top:12px;cursor:pointer;transition:transform 0.3s;}
  img.preview:hover{transform:scale(1.03);}
  @media(max-width:768px){main{flex-direction:column;}}
</style>
</head>
<body>
<header><h1>üìù Text & üì∑ Image Saver</h1></header>
<main>
  <section>
    <h2>Shared Text</h2>
    <textarea id="sharedBox" placeholder="Start typing..."></textarea>
    <div class="meta" id="textMeta"></div>
  </section>

  <section>
    <h2>Image</h2>
    <label class="upload-label" for="fileInput">Upload Image</label>
    <input type="file" id="fileInput" accept="image/*" />
    <div id="imageContainer"></div>
    <div class="meta" id="imageMeta"></div>
  </section>
</main>

<div id="status">Initializing...</div>

<script>
/* ----------------------------
  device id management
---------------------------- */
function getDeviceId() {
  let id = localStorage.getItem("device_id_v1");
  if (!id) { id = crypto.randomUUID(); localStorage.setItem("device_id_v1", id); }
  return id;
}
const DEVICE_ID = getDeviceId();

/* ----------------------------
  detect local subnet using WebRTC trick
---------------------------- */
async function getLocalSubnet() {
  return new Promise(resolve => {
    const pc = new RTCPeerConnection({iceServers:[]});
    pc.createDataChannel("");
    pc.createOffer().then(offer => pc.setLocalDescription(offer)).catch(()=>{});
    pc.onicecandidate = ev => {
      if(ev?.candidate?.candidate){
        const parts = ev.candidate.candidate.split(" ");
        const addr = parts[4];
        if(/^(192\.|10\.|172\.)/.test(addr)){
          resolve(addr.split(".").slice(0,3).join("."));
          pc.close();
        }
      }
    };
    setTimeout(()=>{ try{pc.close()}catch{}; resolve(null); },1000);
  });
}

/* ----------------------------
  UI wiring & polling
---------------------------- */
const sharedBox = document.getElementById("sharedBox");
const fileInput = document.getElementById("fileInput");
const imageContainer = document.getElementById("imageContainer");
const textMeta = document.getElementById("textMeta");
const imageMeta = document.getElementById("imageMeta");
const status = document.getElementById("status");

let localSubnet = null;
let isTyping = false;
let typingTimer = null;

async function init() {
  status.textContent = "Detecting network...";
  localSubnet = await getLocalSubnet();
  status.textContent = "Ready";
  startPolling();
}
init();

function buildHeaders() {
  const h = {"X-Device-ID": DEVICE_ID};
  if(localSubnet) h["X-Local-Subnet"]=localSubnet;
  return h;
}

async function fetchLatest() {
  try {
    const res = await fetch("/get",{headers:buildHeaders()});
    if(!res.ok){
      const err = await res.json().catch(()=>({error:'unknown'}));
      status.textContent = `Sync error: ${err.error||res.status}`;
      return null;
    }
    const data = await res.json();
    if(!data.success){ status.textContent="No data"; return null; }
    status.textContent="Synced";
    return data;
  }catch(e){ console.error(e); status.textContent="Offline"; return null; }
}

async function refreshUI() {
  const data = await fetchLatest();
  if(!data) return;

  if(!isTyping && (data.text||"")!==sharedBox.value) sharedBox.value=data.text||"";
  textMeta.textContent = data.updated_at?`Updated: ${new Date(data.updated_at).toLocaleString()}`:"";

  imageContainer.innerHTML="";
  if(data.image_url){
    const img=document.createElement("img");
    img.src=data.image_url; img.className="preview"; img.onclick=()=>window.open(data.image_url,"_blank");
    imageContainer.appendChild(img);

    const owner=data.owner_device_id;
    const showDelete=!owner||owner===DEVICE_ID;
    if(showDelete){
      const btn=document.createElement("button");
      btn.textContent="‚ùå Remove Image"; btn.className="action-btn remove-btn";
      btn.onclick=async()=>{ await deleteMessage(); await refreshUI(); };
      imageContainer.appendChild(btn);
    }
    imageMeta.textContent=`Updated: ${new Date(data.updated_at).toLocaleString()}`;
  } else { imageMeta.textContent=""; }
}

async function sendMessage({text=null,imageFile=null}={}) {
  try {
    const fd=new FormData();
    if(text!==null) fd.append("text",text);
    if(imageFile) fd.append("image",imageFile);
    const res=await fetch("/send",{method:"POST",body:fd,headers:buildHeaders()});
    if(!res.ok){ const err=await res.json().catch(()=>({error:'unknown'})); alert("Save failed: "+(err.error||res.status)); return null;}
    const data=await res.json(); if(!data.success) alert("Save failed: "+(data.error||"unknown"));
    return data;
  }catch(e){ console.error(e); alert("Send failed"); return null; }
}

async function deleteMessage() {
  try {
    const res=await fetch("/delete",{method:"DELETE",headers:buildHeaders()});
    if(!res.ok){ const err=await res.json().catch(()=>({error:'unknown'})); alert("Delete failed: "+(err.error||res.status)); return;}
    const data=await res.json(); if(!data.success) alert("Delete failed: "+(data.error||"unknown"));
  }catch(e){ console.error(e); alert("Delete failed"); }
}

let pollHandle=null;
function startPolling(){ refreshUI(); if(pollHandle) clearInterval(pollHandle); pollHandle=setInterval(refreshUI,3000); }

sharedBox.addEventListener("input",()=>{
  isTyping=true;
  clearTimeout(typingTimer);
  typingTimer=setTimeout(async()=>{ isTyping=false; await sendMessage({text:sharedBox.value}); },600);
});

fileInput.addEventListener("change",async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  if(f.size>(5*1024*1024)){ alert("Image too large (max 5 MB)"); return;}
  if(!/^image\//.test(f.type)){ alert("Please upload an image"); return;}
  await sendMessage({imageFile:f});
  fileInput.value=""; await refreshUI();
});

/* Manual Delete All button if owner */
const removeAllBtn=document.createElement("button");
removeAllBtn.textContent="Delete All (if owner)";
removeAllBtn.className="action-btn remove-btn";
removeAllBtn.onclick=async()=>{
  if(!confirm("Delete the shared message and image for this network?")) return;
  await deleteMessage(); await refreshUI();
};
document.querySelector("main section:nth-child(2)").appendChild(removeAllBtn);
</script>
</body>
</html>
